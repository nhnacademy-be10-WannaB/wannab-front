<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/admin-layout :: layout (
      ~{::div}
    )}">

<div>
    <h2 class="text-2xl font-bold text-sky-700">쿠폰 정책 관리</h2>
    <!-- 쿠폰 등록 버튼 그룹 -->
    <div class="flex flex-wrap gap-4">
        <!-- 일반 쿠폰 등록 버튼 -->
        <button type="button" data-modal-target="modal-normal-coupon" data-modal-toggle="modal-normal-coupon"
                class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600">
            일반 쿠폰 등록
        </button>

        <!-- 특정 도서 쿠폰 등록 버튼 -->
        <button type="button" data-modal-target="modal-book-coupon" data-modal-toggle="modal-book-coupon"
                class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
            도서 쿠폰 등록
        </button>

        <!-- 카테고리 쿠폰 등록 버튼 -->
        <button type="button" data-modal-target="modal-category-coupon"
                data-modal-toggle="modal-category-coupon"
                class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">
            카테고리 쿠폰 등록
        </button>
    </div>

    <!-- 쿠폰 정책 목록 -->
    <div class="mt-10 bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-bold text-sky-700 mb-4">쿠폰 정책 목록</h2>
        <table class="w-full table-auto text-sm text-left border">
            <thead class="bg-sky-100">
            <tr>
                <th class="p-2">정책명</th>
                <th class="p-2">유형</th>
                <th class="p-2">구매 조건</th>
                <th class="p-2">할인</th>
                <th class="p-2">기간</th>
                <th class="p-2">자동 발급</th>
                <th class="p-2">관리</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y">
            <tr th:each="coupon : ${couponPolicies}" class="hover:bg-gray-50">
                <td class="p-2" th:text="${coupon.couponPolicyName}">정책명</td>
                <td class="p-2" th:text="${coupon.discountType == 'FIXED' ? '정액' : '정률'}">유형</td>

                <td class="p-2">
        <span th:switch="${coupon.couponType}">
            <span th:case="'BOOK'" th:text="${coupon.bookName}"></span>
            <span th:case="'CATEGORY'" th:text="${coupon.categoryName}"></span>
            <span th:case="*" th:text="|${#numbers.formatInteger(coupon.minPurchase, 0, 'COMMA')}원 이상|"></span>
        </span>
                </td>

                <td class="p-2" th:text="${coupon.discountValue}">할인</td>

                <td class="p-2" th:text="${coupon.validDays > 0} ? |발급 후 ${coupon.validDays}일간| : |${coupon.startDate} ~ ${coupon.endDate}|">기간</td>

                <td class="p-2" th:text="${(coupon.couponType == 'WELCOME' or coupon.couponType == 'BIRTHDAY') ? '예' : '아니오'}">자동 발급</td>

                <td class="p-2">
                    <button type="button"
                            th:data-coupon="${@objectMapper.writeValueAsString(coupon)}"
                            class="js-edit-coupon-btn text-sky-600 hover:underline mr-2">
                        상세 보기/수정
                    </button>
                    <button class="text-red-500 hover:underline">삭제</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>


    <!-- 일반 쿠폰 등록 모달 -->
    <div id="modal-normal-coupon" tabindex="-1" aria-hidden="true"
         class="hidden fixed top-0 left-0 right-0 z-50 justify-center items-center w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative w-full max-w-2xl max-h-full">
            <div class="relative bg-white rounded-lg shadow-md border border-sky-100">

                <!-- Modal Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 rounded-t">
                    <h3 class="text-xl font-semibold text-sky-700">일반 쿠폰 등록</h3>
                    <button type="button"
                            class="text-gray-400 hover:bg-gray-100 hover:text-gray-700 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                            data-modal-hide="modal-normal-coupon">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                  stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <form th:action="@{/admin/coupon}" th:object="${couponPolicyCreateDto}" method="post" class="p-4 space-y-4">
                    <input type="hidden" name="couponType" value="NORMAL" />
                    <div>
                        <label class="block mb-1 font-medium">정책명</label>
                        <input type="text" th:field="*{name}" required class="w-full border p-2 rounded-lg" />
                    </div>

                    <div>
                        <label class="block mb-1 font-medium">할인 유형</label>
                        <select th:field="*{discountType}" class="w-full border p-2 rounded-lg">
                            <option value="FIXED">정액 할인</option>
                            <option value="PERCENT">정률 할인</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 font-medium">최소 구매 금액</label>
                            <input type="number" th:field="*{minPurchase}" required
                                   class="w-full border p-2 rounded-lg" />
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">할인 금액 또는 비율</label>
                            <input type="number" th:field="*{discountValue}" required
                                   class="w-full border p-2 rounded-lg" />
                        </div>
                    </div>

                    <div>
                        <label class="block mb-1 font-medium">최대 할인 한도 (정률 할인만 해당)</label>
                        <input type="number" th:field="*{maxDiscount}" class="w-full border p-2 rounded-lg" />
                    </div>

                    <div>
                        <label class="block mb-1 font-medium text-gray-900">유효 기간 타입</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" th:field="*{periodType}" value="FIXED" class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 focus:ring-sky-500" checked>
                                <span class="ms-2 text-sm font-medium text-gray-700">고정 유효기간</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" th:field="*{periodType}" value="RELATIVE" class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 focus:ring-sky-500">
                                <span class="ms-2 text-sm font-medium text-gray-700">상대 유효기간 (발급일 기준)</span>
                            </label>
                        </div>
                    </div>

                    <div id="fixed-period-inputs" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 font-medium">시작일</label>
                            <input type="date" th:field="*{startDate}" class="w-full border p-2 rounded-lg" />
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">종료일</label>
                            <input type="date" th:field="*{endDate}" class="w-full border p-2 rounded-lg" />
                        </div>
                    </div>

                    <div id="relative-period-inputs" class="hidden">
                        <div>
                            <label class="block mb-1 font-medium">유효 일수 (예: 30일이면 30 입력)</label>
                            <input type="number" th:field="*{validDays}" placeholder="발급일로부터 유효한 기간(일)을 입력"
                                   class="w-full border p-2 rounded-lg" />
                        </div>
                    </div>


                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" th:field="*{birthday}" />
                            생일자 자동 발급
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" th:field="*{welcome}" />
                            회원가입 자동 발급
                        </label>
                    </div>

                    <!-- Modal Footer -->
                    <div class="flex justify-end pt-4 border-t border-gray-200 gap-2">
                        <button type="submit"
                                class="text-white bg-sky-500 hover:bg-sky-600 font-medium rounded-lg text-sm px-5 py-2.5">
                            저장
                        </button>
                        <button type="button"
                                class="px-5 py-2.5 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-100"
                                data-modal-hide="modal-normal-coupon">
                            취소
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <!-- 특정 도서 쿠폰 등록 모달 -->
    <div id="modal-book-coupon" tabindex="-1" aria-hidden="true"
         class="hidden fixed top-0 left-0 right-0 z-50 justify-center items-center w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative w-full max-w-2xl max-h-full">
            <div class="relative bg-white rounded-lg shadow-md border border-sky-100">

                <!-- Modal Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 rounded-t">
                    <h3 class="text-xl font-semibold text-sky-700">도서 쿠폰 등록</h3>
                    <button type="button"
                            class="text-gray-400 hover:bg-gray-100 hover:text-gray-700 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                            data-modal-hide="modal-book-coupon">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                  stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                    <form th:action="@{/admin/coupon}" th:object="${couponPolicyCreateDto}" method="post" class="p-4 space-y-4">
                    <input type="hidden" name="couponType" value="BOOK" />

                    <div>
                        <label class="block mb-1 font-medium">정책명</label>
                        <input type="text" th:field="*{name}" required class="w-full border p-2 rounded-lg" />
                    </div>

                    <div>
                        <label for="bookSearchInput" class="block mb-1 font-medium">도서 검색</label>
                        <div class="relative">
                            <input type="text" id="bookSearchInput" autocomplete="off"
                                   placeholder="적용할 도서명을 2글자 이상 입력하세요"
                                   class="w-full border p-2 rounded-lg" />
                            <div id="bookSearchResults" class="hidden absolute w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10"></div>
                        </div>
                    </div>

                    <div>
                        <label class="block mb-1 font-medium">할인 유형</label>
                        <select th:field="*{discountType}" class="w-full border p-2 rounded-lg">
                            <option value="FIXED">정액 할인</option>
                            <option value="RATE">정률 할인</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 font-medium">쿠폰 사용 조건</label>
                            <div id="selectedBookNameDisplay" class="w-full border p-2 rounded-lg bg-gray-100 text-gray-700">
                                검색 후 도서를 선택해주세요.
                            </div>
                            <input type="hidden" th:field="*{targetBookId}" id="targetBookId" />
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">할인 금액 또는 비율</label>
                            <input type="number" th:field="*{discountValue}" required
                                   class="w-full border p-2 rounded-lg" />
                        </div>
                    </div>

                    <div>
                        <label class="block mb-1 font-medium">최대 할인 한도 (정률 할인만 해당)</label>
                        <input type="number" th:field="*{maxDiscount}" class="w-full border p-2 rounded-lg" />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 font-medium">시작일</label>
                            <input type="date" id="startDate_book" th:field="*{startDate}" class="w-full border p-2 rounded-lg" />

                        </div>
                        <div>
                            <label class="block mb-1 font-medium">종료일</label>
                            <input type="date" id="endDate_book" th:field="*{endDate}" class="w-full border p-2 rounded-lg" />
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="flex justify-end pt-4 border-t border-gray-200 gap-2">
                        <button type="submit"
                                class="text-white bg-sky-500 hover:bg-sky-600 font-medium rounded-lg text-sm px-5 py-2.5">
                            저장
                        </button>
                        <button type="button"
                                class="px-5 py-2.5 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-100"
                                data-modal-hide="modal-book-coupon">
                            취소
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <!-- 특정 카테고리 쿠폰 등록 모달 -->
    <div id="modal-category-coupon" tabindex="-1" aria-hidden="true"
         class="hidden fixed top-0 left-0 right-0 z-50 justify-center items-center w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative w-full max-w-2xl max-h-full">
            <div class="relative bg-white rounded-lg shadow-md border border-sky-100">

                <!-- Modal Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 rounded-t">
                    <h3 class="text-xl font-semibold text-sky-700">카테고리 쿠폰 등록</h3>
                    <button type="button"
                            class="text-gray-400 hover:bg-gray-100 hover:text-gray-700 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                            data-modal-hide="modal-category-coupon">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                  stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <form action="" method="post" class="p-4 space-y-4">
                    <input type="hidden" name="couponType" value="CATEGORY" />

                    <div>
                        <label class="block mb-1 font-medium">정책명</label>
                        <input type="text" name="name" required class="w-full border p-2 rounded-lg" />
                    </div>

                    <div>
                        <label class="block mb-1 font-medium">카테고리 선택</label>
                        <select name="mainCategory" class="w-full border p-2 rounded-lg">
                            <option value="">카테고리 선택</option>
                            <option value="IT 모바일">IT 모바일</option>
                            <option value="소설">소설</option>
                            <option value="자기계발">자기계발</option>
                            <!-- 실제 프로젝트에서는 서버 데이터 기반으로 동적 렌더링 권장 -->
                        </select>
                    </div>

                    <div>
                        <label class="block mb-1 font-medium">세부 카테고리 입력 (선택)</label>
                        <input type="text" name="subCategory" placeholder="예: 컴퓨터 교육"
                               class="w-full border p-2 rounded-lg" />
                    </div>

                    <div>
                        <label class="block mb-1 font-medium">할인 유형</label>
                        <select name="discountType" class="w-full border p-2 rounded-lg">
                            <option value="FIXED">정액 할인</option>
                            <option value="RATE">정률 할인</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 font-medium">최소 구매 금액</label>
                            <input type="number" name="minPurchase" required
                                   class="w-full border p-2 rounded-lg" />
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">할인 금액 또는 비율</label>
                            <input type="number" name="discountValue" required
                                   class="w-full border p-2 rounded-lg" />
                        </div>
                    </div>

                    <div>
                        <label class="block mb-1 font-medium">최대 할인 한도 (정률 할인만 해당)</label>
                        <input type="number" name="maxDiscount" class="w-full border p-2 rounded-lg" />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 font-medium">시작일</label>
                            <input type="date" name="startDate" class="w-full border p-2 rounded-lg" />
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">종료일</label>
                            <input type="date" name="endDate" class="w-full border p-2 rounded-lg" />
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="flex justify-end pt-4 border-t border-gray-200 gap-2">
                        <button type="submit"
                                class="text-white bg-sky-500 hover:bg-sky-600 font-medium rounded-lg text-sm px-5 py-2.5">
                            저장
                        </button>
                        <button type="button"
                                class="px-5 py-2.5 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-100"
                                data-modal-hide="modal-category-coupon">
                            취소
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <div id="editCouponModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">쿠폰 정책 수정</h3>

                <form class="mt-4 space-y-4 text-left" onsubmit="event.preventDefault(); alert('저장 로직을 여기에 구현하세요.');">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">쿠폰 정책명</label>
                        <input type="text" id="modal_name" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" disabled>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">할인 유형</label>
                        <input type="text" id="modal_discountType" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" disabled>
                    </div>

                    <div id="modal_minPurchase_container">
                        <label class="block text-sm font-medium text-gray-700">사용 조건 (최소 구매 금액)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input type="number" name="minPurchase" id="modal_minPurchase" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pr-12 sm:text-sm border-gray-300 rounded-md" placeholder="0">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> 원 </span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="modal_discountValue" class="block text-sm font-medium text-gray-700">할인</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input type="number" name="discountValue" id="modal_discountValue" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pr-12 sm:text-sm border-gray-300 rounded-md">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span id="modal_discountUnit" class="text-gray-500 sm:text-sm"> 원 </span>
                            </div>
                        </div>
                    </div>

                    <div id="modal_maxDiscount_container" class="hidden">
                        <label for="modal_maxDiscount" class="block text-sm font-medium text-gray-700">최대 할인 금액</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input type="number" name="maxDiscount" id="modal_maxDiscount" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pr-12 sm:text-sm border-gray-300 rounded-md">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> 원 </span>
                            </div>
                        </div>
                    </div>


                    <div>
                        <label class="block text-sm font-medium text-gray-700">유효 기간</label>
                        <div id="modal_period_days_container" class="mt-1 relative rounded-md shadow-sm">
                            <input type="number" name="validDays" id="modal_validDays" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pr-20 sm:text-sm border-gray-300 rounded-md">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm"> 일 동안 유효 </span>
                            </div>
                        </div>
                        <div id="modal_period_dates_container" class="mt-1 flex items-center space-x-2">
                            <input type="date" name="startDate" id="modal_startDate" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <span>~</span>
                            <input type="date" name="endDate" id="modal_endDate" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div class="flex items-center">
                        <input id="modal_autoIssue" name="autoIssue" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" disabled>
                        <label for="modal_autoIssue" class="ml-2 block text-sm text-gray-900">자동 발급</label>
                    </div>

                    <div class="items-center px-4 py-3">
                        <button id="ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            저장
                        </button>
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            취소
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>