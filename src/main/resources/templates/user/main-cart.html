<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/user-layout :: layout (
        'ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€',
        ~{::body},
        ~{::head}
      )}">

<head>
  <title>ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€</title>
  <link rel="stylesheet" th:href="@{/css/user/main-cart.css}" />
</head>

<body>
  <div class="cart-wrapper">
    <section class="cart-section">
      <div class="cart-container">
        <div class="cart-items">
          <h3>Shopping cart</h3>

          <!-- ì¥ë°”êµ¬ë‹ˆ ë¹„ì–´ìˆì„ ë•Œ -->
          <p th:if="${#lists.isEmpty(cartItems)}">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>

          <!-- ì¥ë°”êµ¬ë‹ˆì— í•­ëª©ì´ ìˆì„ ë•Œ -->
          <p th:unless="${#lists.isEmpty(cartItems)}"
             th:text="|You have ${#lists.size(cartItems)} items in your cart|">
            You have 0 items in your cart
          </p>

          <!-- ì¥ë°”êµ¬ë‹ˆ í•­ëª© ë°˜ë³µ -->
          <div class="cart-item"
            th:each="item, iterStat : ${cartItems}"
            th:attr="data-sales-price=${item.salesPrice}, data-quantity=${item.quantity}">

            <img th:src="@{/static_images/testbook.png}" th:alt="${item.title}" />

            <div class="cart-item-info">
              <strong th:text="${item.title}">ì±… ì œëª©</strong>
              <p>
                <span th:text="|ì •ê°€: ${#numbers.formatInteger(item.originPrice, 3, 'COMMA')}ì›|">ì •ê°€</span> /
                <span th:text="|íŒë§¤ê°€: ${#numbers.formatInteger(item.salesPrice, 3, 'COMMA')}ì›|">íŒë§¤ê°€</span>
              </p>
            </div>

            <!-- ìˆ˜ëŸ‰ ì¡°ì ˆ -->
            <div class="cart-qty">
              <button type="button"
              th:attr="data-book-id=${item.bookId}, data-quantity=${item.quantity - 1}"
              onclick="updateQuantity(this)">-</button>

              <span th:text="${item.quantity}">1</span>

              <button type="button"
                      th:attr="data-book-id=${item.bookId}, data-quantity=${item.quantity + 1}"
                      onclick="updateQuantity(this)">+</button>
            </div>

            <button type="button"
                    class="cart-delete"
                    th:attr="data-book-id=${item.bookId}"
                    onclick="deleteCartItem(this)">ğŸ—‘ï¸</button>

            <!-- ì´ì•¡ -->
            <div class="cart-price"
                 th:text="|${#numbers.formatInteger(item.salesPrice * item.quantity, 3, 'COMMA')}ì›|">
              0ì›
            </div>

            <!-- ì£¼ë¬¸ìš© hidden input (form="orderForm"ìœ¼ë¡œ ì—°ê²°) -->
            <input type="hidden" form="orderForm"
                   th:name="'orderItems[' + ${iterStat.index} + '].bookId'"
                   th:value="${item.bookId}" />
            <input type="hidden" form="orderForm"
                   th:name="'orderItems[' + ${iterStat.index} + '].quantity'"
                   th:value="${item.quantity}" />
          </div>
        </div>

        <!-- ì£¼ë¬¸ìš© form -->
        <form id="orderForm" th:action="@{/user/main-order}" method="post">
          <div class="cart-summary">
            <p>ì´ ì£¼ë¬¸ê¸ˆì•¡: <strong id="totalBookPriceDisplay">0ì›</strong></p>

            <button type="submit" class="order-btn">ì£¼ë¬¸ í•˜ê¸°</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <!-- JavaScript: ìˆ˜ëŸ‰ ë³€ê²½ ë° ì‚­ì œ -->
  <script>
    function updateTotalBookPrice() {
      const cartItems = document.querySelectorAll(".cart-item");
      let total = 0;
      cartItems.forEach(item => {
        const price = parseInt(item.getAttribute("data-sales-price")) || 0;
        const quantity = parseInt(item.getAttribute("data-quantity")) || 1;
        total += price * quantity;
      });

      const display = document.getElementById("totalBookPriceDisplay");
      if (display) {
        display.textContent = total.toLocaleString() + "ì›";
      }
    }

  document.addEventListener("DOMContentLoaded", () => {
    updateTotalBookPrice();
  });

    function updateQuantity(button) {
      const bookId = button.getAttribute("data-book-id");
      const quantity = parseInt(button.getAttribute("data-quantity"));

      if (quantity < 1) {
        alert("ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      fetch(`/user/main-cart/books/${bookId}?quantity=${quantity}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      }).then(() => location.reload());
    }

    function deleteCartItem(button) {
      const bookId = button.getAttribute("data-book-id");

      fetch(`/user/main-cart/books/${bookId}`, {
        method: 'DELETE'
      }).then(() => location.reload());
    }
  </script>
</body>

</html>
