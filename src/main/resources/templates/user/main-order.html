<!-- β… Updated HTML: main-order.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/user-layout :: layout (
      'μ£Όλ¬Έ νμ΄μ§€',
      ~{::body},
      ~{::head}
    )}">

<head>
  <title>μ£Όλ¬Έ νμ΄μ§€</title>
  <link rel="stylesheet" th:href="@{/css/user/main-order.css}" />
</head>

<body>
<div class="order-wrapper">
  <section class="order-section">
    <h2 class="order-title">π§Ύ Check & Order</h2>
    <p class="order-sub">κ²°μ  μ§„ν–‰</p>

    <form th:action="@{/user/main-order/submit}" method="post">
      <div class="order-container">
        <div class="order-main">
          <!-- μƒν’ λ©λ΅ -->
          <div class="order-items">
            <table class="order-table">
              <thead>
              <tr>
                <th>μƒν’</th>
                <th>μλ‰</th>
                <th>νλ§¤κ°€</th>
                <th>ν¬μ¥μ§€</th>
                <th>μΏ ν°</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="book, iterStat : ${orderBookInfos}">
                <td>
                  <div class="order-product">
                    <img th:src="@{/static_images/testbook.png}" />
                    <div class="order-product-info">
                      <strong th:text="${book.title}">μ±… μ λ©</strong>
                    </div>
                  </div>
                  <input type="hidden" th:name="'bookOrderSubmitDtos[' + ${iterStat.index} + '].bookId'" th:value="${book.bookId}" />
                  <input type="hidden" th:name="'bookOrderSubmitDtos[' + ${iterStat.index} + '].bookSalesPrice'" th:value="${book.salesPrice}" />
                  <input type="hidden" th:name="'bookOrderSubmitDtos[' + ${iterStat.index} + '].bookQuantity'" th:value="${book.quantity}" />
                </td>
                <td th:text="${book.quantity}">1</td>
                <td th:text="|${#numbers.formatInteger(book.salesPrice, 3, 'COMMA')}μ›|">0μ›</td>

                <td>
                    <div class="wrap-coupon-row">
                  <!-- ν¬μ¥μ§€ -->
                  <select th:name="'bookOrderSubmitDtos[' + ${iterStat.index} + '].wrappingPaperId'"
                          th:id="'wpSelect' + ${iterStat.index}"
                          th:attr="data-index=${iterStat.index}">
                    <option value="0" data-price="0">ν¬μ¥μ§€ μ„ νƒ μ•ν•¨</option>
                    <option th:each="wp : ${wrappingPaperList}"
                            th:value="${wp.wpId}"
                            th:attr="data-price=${wp.price}"
                            th:text="${wp.name + ' (+ ' + #numbers.formatInteger(wp.price, 3, 'COMMA') + 'μ›)'}">
                    </option>
                  </select>

                  <!-- β… λ„μ„λ³„ μΏ ν° -->
                  <select class="book-coupon-select"
                          th:name="'bookOrderSubmitDtos[' + ${iterStat.index} + '].appliedCouponId'"
                          th:attr="data-base-price=${book.salesPrice}">
                    <option value="" data-discount-value="0" data-discount-type="FIXED">μΏ ν° μ„ νƒ μ•ν•¨</option>
                    <option th:each="cp : ${book.applicableCoupons}"
                            th:value="${cp.couponId}"
                            th:attr="data-discount-value=${cp.discountValue}, data-discount-type=${cp.discountType.name()}"
                            th:text="${cp.couponName + ' (- ' + cp.discountValue + (cp.discountType.name() == 'PERCENT' ? '%' : 'μ›') + ')'}">
                    </option>
                  </select>


                  <input type="hidden" th:id="'wpPriceInput' + ${iterStat.index}"
                         th:name="'bookOrderSubmitDtos[' + ${iterStat.index} + '].wrappingPaperPrice'" value="0" />
                  </div>
                </td>

              </tr>
              </tbody>
            </table>
          </div>

          <!-- β… μ£Όλ¬Έ μ „μ²΄μ— μ μ©λλ” μΏ ν° μ„ νƒ -->
          <div class="order-discount" th:if="${userId >= 0}">
            <h4>μ „μ²΄ μΏ ν° μ„ νƒ</h4>
            <select name="appliedOrderCouponId" id="orderCouponSelect">
              <option value="" data-discount-value="0" data-discount-type="FIXED">μΏ ν° μ„ νƒ μ•ν•¨</option>
              <option th:each="cp : ${orderCoupons}"
                      th:value="${cp.couponId}"
                      th:attr="data-discount-value=${cp.discountValue}, data-discount-type=${cp.discountType.name()}"
                      th:text="${cp.couponName + ' (- ' + cp.discountValue + (cp.discountType.name() == 'PERCENT' ? '%' : 'μ›') + ')'}">
              </option>
            </select>
          </div>

          <!-- β… ν¬μΈνΈ μ‚¬μ© -->
          <div th:if="${userId >= 0}" class="order-discount">
            <h4>ν¬μΈνΈ μ‚¬μ©</h4>
            <input type="number" id="usedPointsInput" name="usedPoints" min="0" placeholder="0" th:attr="max=${userPoints}" />
            <p th:text="|λ³΄μ  ν¬μΈνΈ: ${userPoints}P|">λ³΄μ  ν¬μΈνΈ: 0P</p>
          </div>



          <div class="order-recipient-info">
            <fieldset class="delivery-info-box">
              <legend>μ •λ³΄ μ…λ ¥</legend>
              <div class="input-group">
                <input type="text" name="recipientName" placeholder="λ°›λ”λ¶„ μ΄λ¦„μ„ μ…λ ¥ν•΄μ£Όμ„Έμ”" maxlength="10" required />
              </div>
              <div class="input-group">
                <input type="email" name="email" placeholder="μ΄λ©”μΌ μ£Όμ†λ¥Ό μ…λ ¥ν•΄μ£Όμ„Έμ”" required />
              </div>
              <div class="input-group">
                <input type="tel" name="recipientPhoneNumber" placeholder="λ°›λ”λ¶„ ν΄λ€ν° λ²νΈλ¥Ό β€-β€™μ—†μ΄ μ…λ ¥ν•΄μ£Όμ„Έμ”" required />
              </div>
              <p class="guide-text">μ…λ ¥ν•μ‹  μ •λ³΄λ΅ μ£Όλ¬Έ κ΄€λ ¨ λ¬Έμ λ° λ©”μΌμ΄ λ°μ†΅λ©λ‹λ‹¤.</p>
            </fieldset>

            <fieldset class="delivery-info-box">
             <legend>λ°°μ†΅μ§€ μ •λ³΄</legend>
             <input type="text" name="recipientAddress" placeholder="μ£Όμ†λ¥Ό μ…λ ¥ν•΄μ£Όμ„Έμ”" required />
           </fieldset>
          </div>

          <!-- λΉ„νμ›μΌ κ²½μ° -->
          <div th:if="${userId < 0}" class="guest-info-section">
            <fieldset class="guest-info-box">
              <div class="password-section">
                <strong>μ£Όλ¬Έμ΅°ν λΉ„λ°€λ²νΈ μ…λ ¥</strong>
                <input type="password" name="guestPassword" placeholder="λΉ„λ°€λ²νΈλ¥Ό μ…λ ¥ν•΄μ£Όμ„Έμ”." required />
              </div>
            </fieldset>
          </div>

          <!-- ν¬λ§ λ°°μ†΅ λ‚ μ§ -->
          <div class="delivery-date">
            <h4>ν¬λ§ λ°°μ†΅ λ‚ μ§</h4>
            <input type="date" name="deliveryRequestAt" />
          </div>


        </div>

        <!-- μ£Όλ¬Έ μ”μ•½ -->
        <div class="order-summary">
          <p>μ£Όλ¬ΈκΈμ•΅: <span th:text="|${#numbers.formatInteger(totalBookPrice, 3, 'COMMA')}μ›|">0μ›</span></p>
          <p>μΏ ν°ν• μΈ: <span class="minus" id="couponDiscountDisplay">-0μ›</span></p>
          <p>ν¬μΈνΈ: <span class="minus" id="usedPointsDisplay">-0μ›</span></p>
          <p>ν¬μ¥μ§€: <span class="plus" id="wrappingPriceDisplay">+0μ›</span></p>
          <p>λ°°μ†΅λΉ„: <span class="plus" th:text="|+ ${#numbers.formatInteger(shippingFee, 3, 'COMMA')}μ›|">+0μ›</span></p>
          <p class="summary-total">
            κ²°μ μμ •κΈμ•΅:
            <strong id="finalAmountDisplay" th:text="|${#numbers.formatInteger(totalBookPrice + shippingFee, 3, 'COMMA')}μ›|">0μ›</strong>
          </p>
          <button class="order-btn" type="submit">κ²°μ  ν•κΈ°</button>
        </div>
      </div>
    </form>
  </section>
</div>

<script th:inline="javascript">
  let totalBookPrice = /*[[${totalBookPrice != null ? totalBookPrice : 0}]]*/ 0;
  let shippingFee = /*[[${shippingFee != null ? shippingFee : 0}]]*/ 0;
</script>
<script th:src="@{/js/main-order.js}"></script>
</body>
</html>
